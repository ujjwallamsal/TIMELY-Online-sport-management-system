# Real Stripe Checkout Integration - Implementation Complete

This document describes the real Stripe payment integration for the TIMELY sports management system.

## Overview

The system now uses **real Stripe Checkout Sessions** for ticket and registration payments, with an admin approval workflow after successful payment.

## Environment Variables Required

### Backend (.env)

Create `/timely-backend/.env` with:

```env
STRIPE_SECRET_KEY=sk_live_YOUR_STRIPE_SECRET_KEY
STRIPE_WEBHOOK_SECRET=whsec_YOUR_WEBHOOK_SECRET
```

### Frontend (.env)

Create `/timely-frontend/.env` with:

```env
VITE_API_BASE_URL=http://127.0.0.1:8000/api
VITE_STRIPE_PUBLISHABLE_KEY=pk_live_YOUR_STRIPE_PUBLISHABLE_KEY
```

**⚠️ IMPORTANT:** 
- These .env files are gitignored and should NEVER be committed
- Get your actual Stripe keys from your Stripe Dashboard or project documentation
- For security, keys are stored locally only and not in version control

## Development Setup with Stripe CLI

For local development, you need to forward webhooks using the Stripe CLI:

### Install Stripe CLI

```bash
# macOS
brew install stripe/stripe-cli/stripe

# Or download from: https://stripe.com/docs/stripe-cli
```

### Login to Stripe

```bash
stripe login
```

### Forward Webhooks (Required for development)

```bash
stripe listen --forward-to http://127.0.0.1:8000/api/stripe/webhook/
```

This command will output a webhook secret like: `whsec_...`

**Copy this secret to your backend .env file as `STRIPE_WEBHOOK_SECRET`**

Keep this terminal running while testing!

### Test Mode vs Live Mode

The keys provided above are **LIVE MODE** keys. For development:

1. Use Stripe test mode keys (pk_test_... and sk_test_...)
2. Use test card: `4242 4242 4242 4242` (any future expiry, any CVC)
3. The webhook secret will be generated by `stripe listen` command

## Payment Flow

### 1. Paid Events

**User Flow:**
1. User clicks "Get Ticket" on an event with `fee_cents > 0`
2. Frontend calls `POST /api/tickets/checkout/` with `{event_id, quantity, mode}`
3. Backend creates a `TicketOrder` with status `payment_pending` and a unique `client_reference_id`
4. Backend creates a Stripe Checkout Session
5. User is redirected to Stripe's hosted checkout page
6. User completes payment with card
7. Stripe sends `checkout.session.completed` webhook
8. Backend marks order as `paid`, creates tickets with status `pending_approval`
9. Notifications sent to user (payment success) and admin (approval needed)
10. Admin approves in Django Admin
11. Ticket status changes to `approved`, user receives notification
12. Ticket appears in Schedule, QR code is available

**Success Page:**
- `/tickets/checkout/success?session_id=...`
- Shows order summary
- Displays "Pending Approval" badge
- Links to "My Tickets"

**Cancel Page:**
- `/events/:eventId/checkout?canceled=1`
- Shows friendly cancellation message
- Allows retry

### 2. Free Events

**User Flow:**
1. User clicks "Get Ticket" on an event with `fee_cents === 0`
2. Backend creates `TicketOrder` with status `free`
3. Tickets created with status `pending_approval`
4. Notifications sent to user and admin
5. Admin approves
6. Ticket status changes to `approved`

## API Endpoints

### POST /api/tickets/checkout/

Create checkout session or process free ticket.

**Request:**
```json
{
  "event_id": 123,
  "quantity": 2,
  "mode": "ticket"
}
```

**Response (Paid):**
```json
{
  "sessionId": "cs_test_...",
  "publicKey": "pk_live_...",
  "order_id": 456
}
```

**Response (Free):**
```json
{
  "status": "pending_approval",
  "order_id": 456,
  "message": "Free ticket submitted for approval"
}
```

### POST /api/stripe/webhook/

Handles Stripe webhook events. **No authentication** (signature verified).

Handles:
- `checkout.session.completed` → Mark order as paid, create tickets
- `payment_intent.payment_failed` → Mark order as failed, notify user

### GET /api/tickets/orders/by_session/?session_id=...

Retrieve order details by Stripe session ID (for success page).

**Response:**
```json
{
  "order_id": 456,
  "event_id": 123,
  "event_name": "Basketball Tournament",
  "status": "paid",
  "total_cents": 5000,
  "currency": "usd",
  "quantity": 2,
  "tickets": [
    {"id": 789, "serial": "TKT-ABC123", "status": "pending_approval"}
  ]
}
```

## Database Schema Changes

### TicketOrder Model

**New Fields:**
- `client_reference_id` - Unique identifier for Stripe session matching
- **New Status Values:**
  - `payment_pending` - Awaiting payment
  - `paid` - Payment successful, awaiting approval
  - `free` - Free ticket (no payment)
  - `failed` - Payment failed

### Ticket Model

**New Fields:**
- `approved_by` - FK to User who approved
- `approved_at` - DateTime of approval

**New Status Values:**
- `pending_approval` - Awaiting admin approval (default)
- `approved` - Admin approved, can use
- `rejected` - Admin rejected

## Frontend Components

### Updated Components

1. **Checkout.tsx**
   - Uses `@stripe/stripe-js` for real Stripe redirect
   - Handles free vs paid flow
   - Shows detailed errors

2. **CheckoutSuccess.tsx** (NEW)
   - Displays order confirmation
   - Shows pending approval badge
   - Links to My Tickets

3. **CheckoutCancel.tsx** (NEW)
   - Shows cancellation message
   - Allows retry

4. **MyTickets.tsx**
   - Displays `pending_approval` status with yellow badge
   - Shows "Admin review pending" message
   - Disables QR code until approved
   - Shows approved tickets with green badge

## Notifications

### User Notifications

1. **Payment Success:**
   - Kind: `success`
   - Topic: `payment`
   - Body: "Your payment was successful. Your order is submitted for admin approval."
   - Link: `/tickets/me`

2. **Ticket Approved:**
   - Kind: `success`
   - Topic: `ticket`
   - Body: "Your ticket for [Event] has been approved!"
   - Link: `/tickets/me`

### Admin Notifications

1. **New Order:**
   - Kind: `info`
   - Topic: `ticket`
   - Body: "New paid order from [user] for [event]"
   - Link: `/admin/tickets/ticketorder/[id]/change/`

## Admin Approval (Django Admin)

Admins approve tickets via Django Admin:

1. Navigate to: `http://127.0.0.1:8000/admin/tickets/ticketorder/`
2. Click on order
3. View ticket inline
4. Change ticket status to `approved`
5. Save
6. User receives notification automatically

## Testing Checklist

### Paid Event Flow

- [ ] Navigate to event with fee_cents > 0
- [ ] Click "Get Ticket"
- [ ] Redirected to Stripe checkout
- [ ] Complete payment with test card `4242 4242 4242 4242`
- [ ] Redirected to success page
- [ ] Order shown with "Pending Approval"
- [ ] Notification received
- [ ] Admin sees notification
- [ ] Admin approves ticket in Django Admin
- [ ] User receives approval notification
- [ ] Ticket shows as "Approved" in My Tickets
- [ ] QR code is available
- [ ] Ticket appears in Schedule

### Free Event Flow

- [ ] Navigate to event with fee_cents === 0
- [ ] Click "Get Ticket"
- [ ] Immediately shown "Submitted for approval"
- [ ] Ticket in My Tickets with "Pending Approval"
- [ ] Admin approves
- [ ] Ticket shows as "Approved"

### Failure Paths

- [ ] Cancel checkout → shown cancel page with retry option
- [ ] Invalid event_id → clear error message
- [ ] Network error → clear error message
- [ ] Payment failure → notification sent, order marked failed

### Registration Flow (Similar)

- [ ] Athlete/Team registration with fee → Stripe checkout
- [ ] After payment → pending approval
- [ ] Admin approves → appears in My Registrations and Schedule

## Files Modified/Created

### Backend

**New Files:**
- `tickets/views_checkout.py` - Real Stripe checkout endpoint
- `tickets/views_webhook.py` - Webhook handler

**Modified Files:**
- `tickets/models.py` - Added approval fields and statuses
- `tickets/urls.py` - Updated routes
- `api/urls.py` - Added webhook route

**Deleted Files:**
- `tickets/views_ticketing.py` - Removed mock implementation
- `tickets/views_stripe.py` - Removed old Stripe integration
- `tickets/models_backup.py` - Removed backup file

### Frontend

**New Files:**
- `features/tickets/CheckoutSuccess.tsx`
- `features/tickets/CheckoutCancel.tsx`

**Modified Files:**
- `features/tickets/Checkout.tsx` - Real Stripe integration
- `features/tickets/MyTickets.tsx` - Approval status badges
- `app/routes.tsx` - Added success/cancel routes

## Migrations

Run migrations to add new fields:

```bash
cd timely-backend
python manage.py makemigrations
python manage.py migrate
```

## Security Notes

1. **Never log Stripe keys** - Already handled in code
2. **Verify webhook signatures** - Implemented with STRIPE_WEBHOOK_SECRET
3. **Use HTTPS in production** - Required for Stripe webhooks
4. **Store keys in .env only** - Never commit to git
5. **Rotate keys if compromised** - Via Stripe Dashboard

## Production Deployment

### Backend

1. Set environment variables in production server
2. Configure Stripe webhook endpoint:
   - URL: `https://your-domain.com/api/stripe/webhook/`
   - Events: `checkout.session.completed`, `payment_intent.payment_failed`
3. Copy webhook secret to `STRIPE_WEBHOOK_SECRET`
4. Run migrations
5. Restart server

### Frontend

1. Build with production .env
2. Deploy static files
3. Ensure CORS allows frontend domain

## Support & Troubleshooting

### Webhook Not Firing

1. Check Stripe CLI is running: `stripe listen --forward-to ...`
2. Check webhook secret is in .env
3. Check Django logs for signature errors

### Payment Succeeds but Order Not Updated

1. Check Django logs for webhook processing errors
2. Verify `client_reference_id` is being set correctly
3. Check database for order status

### QR Code Not Showing

1. Verify ticket status is `approved` or `valid`
2. Check `qr_payload` field is populated
3. Verify user has permission to view ticket

## Next Steps

1. Implement QR code generation (currently placeholder)
2. Add PDF ticket download functionality
3. Implement refund flow
4. Add email notifications (currently in-app only)
5. Add analytics dashboard for payments

## Contact

For questions or issues, contact the development team or refer to Stripe documentation at https://stripe.com/docs

